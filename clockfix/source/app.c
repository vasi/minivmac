/*	app.c	Copyright (C) 2007 Paul C. Pratt	You can redistribute this file and/or modify it under the terms	of version 2 of the GNU General Public License as published by	the Free Software Foundation.  You should have received a copy	of the license along with this file; see the file COPYING.	This file is distributed in the hope that it will be useful,	but WITHOUT ANY WARRANTY; without even the implied warranty of	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the	license for more details.*/#include "MYMACAPI.i"#include "COREDEFS.i"#include "POW2UTIL.i"#include "MACENVRN.i"#include "MACINITS.i"#include "SAVEDERR.i"LOCALVAR blnr ProgramDone = falseblnr;LOCALFUNC tMyErr GotRequiredParams(const AppleEvent *theAppleEvent){	tMyErr err;	DescType typeCode;	Size actualSize;	/* Make sure there are no additional "required" parameters. */	err = AEGetAttributePtr(theAppleEvent, keyMissedKeywordAttr,		typeWildCard, &typeCode, NULL, 0, &actualSize);	if (errAEDescNotFound == err) {		/* no more required params */		err = noErr;	} else if (noErr == err) {		/* missed required param */		err = errAEEventNotHandled;	} else {		/* other error */	}	return err;}static pascal OSErr DoOpenEvent(const AppleEvent *theAppleEvent, AppleEvent *reply, long aRefCon)/*This is the alternative to getting an open document event on startup.*/{#pragma unused(reply, aRefCon)	tMyErr err;	err = GotRequiredParams(theAppleEvent);	vCheckSysErr(err);	return noErr;}static pascal OSErr DoQuitEvent(const AppleEvent *theAppleEvent, AppleEvent *reply, long aRefCon){#pragma unused(reply, aRefCon)	tMyErr err;	if (noErr == (err = GotRequiredParams(theAppleEvent))) {		ProgramDone = trueblnr;	}	vCheckSysErr(err);	return noErr;}LOCALFUNC tMyErr MyInstallEventHandler(AEEventClass theAEEventClass,	AEEventID theAEEventID, AEEventHandlerProcPtr p,	long handlerRefcon, blnr isSysHandler){	return AEInstallEventHandler(theAEEventClass,		theAEEventID, p, handlerRefcon, isSysHandler);}LOCALFUNC tMyErr InstallAppleEventHandlers(void){	tMyErr err;	if (noErr == (err = AESetInteractionAllowed(kAEInteractWithLocal)))	if (noErr == (err = MyInstallEventHandler(kCoreEventClass, kAEOpenApplication, DoOpenEvent, 0, false)))	if (noErr == (err = MyInstallEventHandler(kCoreEventClass, kAEQuitApplication, DoQuitEvent, 0, false)))	{	}	return err;}/**** event handling *****/LOCALVAR EventRecord curevent;LOCALPROC ProcessHighLevelEvt(void){	AEEventClass thisClass;	thisClass = (AEEventClass)curevent.message;	if (kCoreEventClass == thisClass) {		OSErr err = AEProcessAppleEvent(&curevent);		if (errAEEventNotHandled == err) {			/* ignore */		} else {			vCheckSysErr(err);		}	} else {		vCheckSysErr(errAENotAppleEvent);	}}LOCALPROC ProcessMacEvent(void){	switch (curevent.what) {		case kHighLevelEvent:			ProcessHighLevelEvt();			break;		default:			/* ignore mouseUp, activateEvt, keyUp, osEvt */			break;	}}LOCALPROC ProgramMain(void){	unsigned long secs;	while (! ProgramDone) {		if (WaitNextEvent(everyEvent, &curevent, 60, NULL)) {			ProcessMacEvent();		}		ReadDateTime(&secs);	}}LOCALPROC ProgramZapVars(void){}LOCALPROC ProgramPreInit(void){	/* work around bug, see TN1070 */	THz myZone = GetZone();	if (myZone->bkLim != LMGetHeapEnd()) {		LMSetHeapEnd(myZone->bkLim);	}	MaxApplZone();	InitGraf((Ptr) &qd.thePort);}LOCALFUNC blnr ProgramInit(void){	if (HaveWaitNextEventAvail())	if (HaveAppleEvtMgrAvail())	{		(void) InstallAppleEventHandlers();		return trueblnr;	}	return falseblnr;}LOCALPROC ProgramUnInit(void){}int main(void){	ProgramZapVars();	ProgramPreInit();	if (ProgramInit()) {		ProgramMain();	}	ProgramUnInit();	return 0;}