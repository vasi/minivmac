/*	app.c	Copyright (C) 2004 Paul Pratt	You can redistribute this file and/or modify it under the terms	of version 2 of the GNU General Public License as published by	the Free Software Foundation.  You should have received a copy	of the license along with with this file; see the file COPYING.	This file is distributed in the hope that it will be useful,	but WITHOUT ANY WARRANTY; without even the implied warranty of	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the	license for more details.*/#define IsAnApp 1#include "MYMACAPI.i"#include "COREDEFS.i"#include "POW2UTIL.i"#include "STRUTILS.i"#include "MACENVRN.i"#include "MACINITS.i"/* Menu Constants */#define kMyMenuBar 128#define kAppleMenu   128#define kFileMenu    129#define kEditMenu    130/* File */#define kFileQuitItem 1/* Edit */#define kEditUndoItem 1/* -- seperator 2  */#define kEditCutItem 3#define kEditCopyItem 4#define kEditPasteItem 5#define kEditClearItem 6#define kEditSelectAllItem 7#define EmptyStrConst ((StringPtr)"\000")#define MouseOrKeyMask (mDownMask | mUpMask | keyDownMask | keyUpMask | autoKeyMask)#define rAboutAlert 128LOCALPROC MyAlertFromIdPStr(SInt16 alertID, StringPtr s){	ParamText(s, EmptyStrConst, EmptyStrConst, EmptyStrConst);	FlushEvents(MouseOrKeyMask, 0);	ResetAlertStage();	(void) Alert(alertID, NULL);}LOCALPROC GetVersLongStr(StringPtr s){	ui3p p;	Handle h = GetResource('vers', 1);	if (NULL == h) {		PStrClear(s);	} else {		HLock(h);		p = (ui3p)*h;		p += 6;		p += *p + 1;		PStrFromPtr((MyPtr)p + 1, *p, s);		HUnlock(h);	}}LOCALPROC ShowAboutMessage(void){	MyPStr s;	GetVersLongStr(s);	MyAlertFromIdPStr(rAboutAlert, s);}LOCALVAR blnr ProgramDone;LOCALPROC ResumeSystemCursor(void){	SetCursor(&(qd.arrow));}LOCALVAR short ApplRsrcRefNum;LOCALPROC ApplRsrcRefInit(void){	ApplRsrcRefNum = CurResFile();}LOCALVAR EventRecord curevent;LOCALVAR WindowPtr MacEventWind;LOCALPROC CheckSystemState(void)/*	Call to repair state after system has	done unknown things*/{	if (CurResFile() != ApplRsrcRefNum) {		UseResFile(ApplRsrcRefNum);	}}LOCALPROC MyDeskAccOpen(StringPtr name){	ResumeSystemCursor();	(void) OpenDeskAcc(name);}LOCALPROC MyDeskAccClose(WindowPtr w){	SelectWindow(w);	SetPortWindowPort(w);	CloseDeskAcc(GetWindowKind(w));}LOCALPROC MyDeskAccEditMenuItem(short mItem){	DISCARDVAL SystemEdit(mItem - 1);}LOCALPROC inSysWindowAction(void){	SetPortWindowPort(MacEventWind);	SystemClick(&curevent, (WindowPtr)MacEventWind);}LOCALPROC inDragAction(void){	Rect totalrect;	totalrect = qd.screenBits.bounds;	totalrect.top = totalrect.top + 20;	InsetRect(&totalrect, 4, 4);	DragWindow(MacEventWind, curevent.where, &totalrect);}LOCALPROC CloseAWindow(WindowPtr w){	if (GetWindowKind(w) < 0) {		MyDeskAccClose(w);	} else {		DisposeWindow(w); /* get rid of it, whatever it is */	}}LOCALPROC inGoAwayAction(void){	if (TrackGoAway(MacEventWind, curevent.where)) {		CloseAWindow(MacEventWind);	}}LOCALPROC ProcessUpdateEvt(void){	GrafPtr saveport;	MacEventWind = (WindowPtr)curevent.message;	GetPort(&saveport);	SetPortWindowPort(MacEventWind);	BeginUpdate(MacEventWind);	EndUpdate(MacEventWind);	SetPort(saveport);}LOCALPROC ProcessDiskEvt(void){	Point where;	if (HiWord(curevent.message) != noErr) {		SetPt(&where, 70, 50);		ResumeSystemCursor();		DISCARDVAL DIBadMount(where, curevent.message);	}}LOCALPROC CloseAllWindows(void){	while (FrontWindow() != NULL) {		CloseAWindow(FrontWindow());	}}LOCALPROC ProgramZapVars(void){	ProgramDone = false;}LOCALPROC MyDeskAccMenuItem(short mItem){	Str255 s;	GetMenuItemText(GetMenuHandle(kAppleMenu), mItem, s);	MyDeskAccOpen(s);}LOCALPROC DecodeSysMenus(short mID, short mItem){	switch (mID) {		case kAppleMenu:			if (mItem == 1) {				ShowAboutMessage();			} else {				MyDeskAccMenuItem(mItem);			}			break;		case kFileMenu:			switch (mItem) {				case kFileQuitItem:					ProgramDone = trueblnr;					break;			}			break;		case kEditMenu:			if (FrontWindow() != NULL) {				if (GetWindowKind(FrontWindow()) < 0) {					MyDeskAccEditMenuItem(mItem);				}			}			break;		default:			break;	}}LOCALPROC MyMenusInit(void){	SetMenuBar(GetNewMBar(kMyMenuBar));	AppendResMenu(GetMenuHandle(kAppleMenu), 'DRVR');	DrawMenuBar();}LOCALPROC ProcessKeyDown(void){	blnr CmdKeyDown = AndBits(curevent.modifiers, cmdKey) != 0;	if (CmdKeyDown) {		unsigned char theChar = AndBits(curevent.message, 255);		long menuItem = MenuKey(theChar);		if (HiWord(menuItem) > 0) {			DecodeSysMenus(HiWord(menuItem), LoWord(menuItem));		}		HiliteMenu(0);	}}LOCALPROC inMenuBarAction(void){	long LongResult;	LongResult = MenuSelect(curevent.where);	if (HiWord(LongResult) != 0) {		DecodeSysMenus(HiWord(LongResult), LoWord(LongResult));	}	HiliteMenu(0);}LOCALPROC ProcessMouseDown(void){	short which_part;	which_part = FindWindow(curevent.where, &MacEventWind);	switch (which_part) {		case inDesk:			/* nothing */			break;		case inSysWindow:			inSysWindowAction();			break;		case inDrag:			inDragAction();			break;		case inGoAway:			inGoAwayAction();			break;		case inMenuBar:			inMenuBarAction();			break;		case inGrow:		case inContent:		case inZoomIn:		case inZoomOut:			break;	}}LOCALPROC ProgramMain(void){	do {		if (GetNextEvent(everyEvent, &curevent)) {			switch (curevent.what) {				case keyDown:				case autoKey:					ProcessKeyDown();					break;				case mouseDown:					ProcessMouseDown();					break;				case diskEvt:					ProcessDiskEvt();					break;				case updateEvt:					ProcessUpdateEvt();					break;				case activateEvt:				case mouseUp:					/* ignore */					break;				default:					break;			}		}		SystemTask();		CheckSystemState();		if (FrontWindow() == NULL) {			ProgramDone = trueblnr;		}	} while (! ProgramDone);}LOCALPROC ProgramInit(void){	MyMacHeapInit();	MoreMasters();	MoreMasters();	MyMacToolBoxInit();	ApplRsrcRefInit();	MyMenusInit();	MyDeskAccMenuItem(3);}LOCALPROC ProgramUnInit(void){	CloseAllWindows();}int main(void){	ProgramZapVars();	ProgramInit();	ProgramMain();	ProgramUnInit();	return 0;}